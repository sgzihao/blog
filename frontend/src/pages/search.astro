---
// src/pages/search.astro
import SiteLayout from '../layouts/SiteLayout.astro'
import { searchArticles, formatDate } from '../lib/api'

const { searchParams } = Astro.url
const q = searchParams.get('q') || ''
const type = searchParams.get('type') || ''

let results: any[] = []
let searchTime = 0

if (q) {
  const start = Date.now()
  const data = await searchArticles(q, type || undefined)
  results = data.results
  searchTime = Date.now() - start
}
---

<SiteLayout title={q ? `Search "${q}"` : 'Search'}>
  <div class="max-w-3xl mx-auto px-4 sm:px-6 py-12">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-2xl font-display font-bold text-white mb-6">Search</h1>

      <!-- Search Form -->
      <form method="get" class="flex gap-2">
        <div class="flex-1 relative">
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input 
            type="text" 
            name="q" 
            value={q}
            placeholder="Search blog posts and wiki notes..."
            class="input pl-11 text-base h-12"
            autofocus
          />
        </div>
        <select name="type" class="select w-28 h-12">
          <option value="" selected={!type}>All</option>
          <option value="blog" selected={type === 'blog'}>Blog</option>
          <option value="wiki" selected={type === 'wiki'}>Wiki</option>
        </select>
        <button type="submit" class="btn-primary h-12 px-6">Search</button>
      </form>
    </div>

    <!-- Results -->
    {q && (
      <div>
        <div class="flex items-center gap-2 text-sm text-slate-500 mb-6">
          <span><strong class="text-slate-300">{results.length}</strong> results</span>
          {searchTime > 0 && <span>¬∑ {searchTime}ms</span>}
          {q && <span class="text-accent-cyan">"{q}"</span>}
        </div>

        {results.length > 0 ? (
          <div class="space-y-4">
            {results.map(result => {
              const basePath = result.type === 'blog' ? '/blog/post' : '/wiki/post'
              return (
                <article class="card p-5 hover:border-surface-500 transition-all group">
                  <div class="flex items-start gap-4">
                    <div class={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${result.type === 'blog' ? 'bg-cyan-500/10' : 'bg-purple-500/10'}`}>
                      {result.type === 'blog' ? (
                        <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                      ) : (
                        <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                      )}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-1">
                        <span class={result.type === 'blog' ? 'badge-blog' : 'badge-wiki'}>
                          {result.type === 'blog' ? 'Blog' : 'Wiki'}
                        </span>
                        <time class="text-slate-500 text-xs">{formatDate(result.created_at)}</time>
                      </div>
                      <h2 class="font-semibold text-white group-hover:text-accent-cyan transition-colors mb-2">
                        <a href={`${basePath}?slug=${encodeURIComponent(result.slug)}`}>{result.title}</a>
                      </h2>
                      {result.highlight ? (
                        <p class="text-slate-400 text-sm leading-6 search-highlight" set:html={result.highlight} />
                      ) : result.excerpt ? (
                        <p class="text-slate-400 text-sm leading-6">{result.excerpt}</p>
                      ) : null}
                    </div>
                  </div>
                </article>
              )
            })}
          </div>
        ) : (
          <div class="text-center py-16">
            <div class="text-5xl mb-4">üîç</div>
            <p class="text-lg font-medium text-slate-300 mb-2">No results found</p>
            <p class="text-slate-500 text-sm">Try different keywords.</p>
          </div>
        )}
      </div>
    )}

    {!q && (
      <div class="text-center py-16">
        <div class="text-5xl mb-4">‚ú®</div>
        <p class="text-slate-400">Type a keyword to start searching</p>
        <p class="text-slate-600 text-sm mt-2">Searches titles and full article content.</p>
        <p class="text-slate-600 text-sm mt-1">Shortcut: <kbd class="px-1.5 py-0.5 bg-surface-700 rounded text-xs font-mono">‚åòK</kbd></p>
      </div>
    )}
  </div>
</SiteLayout>

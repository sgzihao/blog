---
// src/pages/search.astro
import SiteLayout from '../layouts/SiteLayout.astro'
const apiUrl = (import.meta.env.PUBLIC_API_URL || 'http://localhost:8787').replace(/\/+$/, '')
---

<SiteLayout title="Search">
  <div id="runtime-config" data-api-url={apiUrl} class="hidden"></div>
  <div class="max-w-3xl mx-auto px-4 sm:px-6 py-12">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-2xl font-display font-bold text-white mb-6">Search</h1>

      <!-- Search Form -->
      <form id="search-form" class="flex gap-2">
        <div class="flex-1 relative">
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input 
            id="search-input"
            type="text" 
            name="q" 
            placeholder="Search blog posts and wiki notes..."
            class="input pl-11 text-base h-12"
            autofocus
          />
        </div>
        <select id="search-type" name="type" class="select w-28 h-12">
          <option value="">All</option>
          <option value="blog">Blog</option>
          <option value="wiki">Wiki</option>
        </select>
        <button type="submit" class="btn-primary h-12 px-6">Search</button>
      </form>
    </div>

    <div id="search-summary" class="hidden items-center gap-2 text-sm text-slate-500 mb-6"></div>
    <div id="search-results"></div>
  </div>
</SiteLayout>

<script type="module">
  const runtimeConfig = document.getElementById('runtime-config')
  const API = (runtimeConfig?.getAttribute('data-api-url') || 'http://localhost:8787').replace(/\/+$/, '')
  const form = document.getElementById('search-form')
  const input = document.getElementById('search-input')
  const typeSelect = document.getElementById('search-type')
  const summary = document.getElementById('search-summary')
  const resultsEl = document.getElementById('search-results')

  function escapeHtml(str) {
    return String(str || '').replace(/[&<>"']/g, (ch) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch]))
  }

  function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  }

  function renderEmptyHint() {
    resultsEl.innerHTML = `
      <div class="text-center py-16">
        <div class="text-5xl mb-4">‚ú®</div>
        <p class="text-slate-400">Type a keyword to start searching</p>
        <p class="text-slate-600 text-sm mt-2">Searches titles and full article content.</p>
        <p class="text-slate-600 text-sm mt-1">Shortcut: <kbd class="px-1.5 py-0.5 bg-surface-700 rounded text-xs font-mono">‚åòK</kbd></p>
      </div>
    `
  }

  function renderNoResults() {
    resultsEl.innerHTML = `
      <div class="text-center py-16">
        <div class="text-5xl mb-4">üîç</div>
        <p class="text-lg font-medium text-slate-300 mb-2">No results found</p>
        <p class="text-slate-500 text-sm">Try different keywords.</p>
      </div>
    `
  }

  function renderResults(results) {
    resultsEl.innerHTML = results.map((result) => {
      const basePath = result.type === 'blog' ? '/blog/post' : '/wiki/post'
      const icon = result.type === 'blog'
        ? '<svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>'
        : '<svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
      const highlight = result.highlight
        ? `<p class="text-slate-400 text-sm leading-6 search-highlight">${result.highlight}</p>`
        : (result.excerpt ? `<p class="text-slate-400 text-sm leading-6">${escapeHtml(result.excerpt)}</p>` : '')

      return `
        <article class="card p-5 hover:border-surface-500 transition-all group">
          <div class="flex items-start gap-4">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${result.type === 'blog' ? 'bg-cyan-500/10' : 'bg-purple-500/10'}">
              ${icon}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="${result.type === 'blog' ? 'badge-blog' : 'badge-wiki'}">${result.type === 'blog' ? 'Blog' : 'Wiki'}</span>
                <time class="text-slate-500 text-xs">${formatDate(result.created_at)}</time>
              </div>
              <h2 class="font-semibold text-white group-hover:text-accent-cyan transition-colors mb-2">
                <a href="${basePath}?slug=${encodeURIComponent(result.slug)}">${escapeHtml(result.title)}</a>
              </h2>
              ${highlight}
            </div>
          </div>
        </article>
      `
    }).join('')
  }

  function setSummary(count, q, searchTime) {
    summary.classList.remove('hidden')
    summary.classList.add('flex')
    summary.innerHTML = `
      <span><strong class="text-slate-300">${count}</strong> results</span>
      ${searchTime > 0 ? `<span>¬∑ ${searchTime}ms</span>` : ''}
      <span class="text-accent-cyan">"${escapeHtml(q)}"</span>
    `
  }

  function clearSummary() {
    summary.classList.add('hidden')
    summary.classList.remove('flex')
    summary.innerHTML = ''
  }

  function applyParamsToForm() {
    const params = new URLSearchParams(window.location.search)
    input.value = params.get('q') || ''
    typeSelect.value = params.get('type') || ''
    return { q: input.value.trim(), type: typeSelect.value.trim() }
  }

  async function runSearchFromUrl() {
    const { q, type } = applyParamsToForm()
    if (!q) {
      clearSummary()
      renderEmptyHint()
      document.title = 'Search'
      return
    }

    const query = new URLSearchParams({ q })
    if (type) query.set('type', type)

    const start = Date.now()
    try {
      const res = await fetch(`${API}/api/search?${query}`)
      if (!res.ok) throw new Error(`HTTP ${res.status}`)
      const data = await res.json()
      const results = Array.isArray(data.results) ? data.results : []
      setSummary(results.length, q, Date.now() - start)
      document.title = `Search "${q}"`

      if (results.length > 0) renderResults(results)
      else renderNoResults()
    } catch (err) {
      console.warn('Search failed:', err)
      clearSummary()
      resultsEl.innerHTML = `
        <div class="text-center py-16">
          <div class="text-5xl mb-4">‚ö†Ô∏è</div>
          <p class="text-lg font-medium text-slate-300 mb-2">Search failed</p>
          <p class="text-slate-500 text-sm">Please try again.</p>
        </div>
      `
    }
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault()
    const q = input.value.trim()
    const type = typeSelect.value.trim()
    const params = new URLSearchParams()
    if (q) params.set('q', q)
    if (type) params.set('type', type)
    const nextUrl = params.toString() ? `/search?${params.toString()}` : '/search'
    window.history.pushState({}, '', nextUrl)
    runSearchFromUrl()
  })

  window.addEventListener('popstate', () => {
    runSearchFromUrl()
  })

  runSearchFromUrl()
</script>

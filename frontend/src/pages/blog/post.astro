---
import SiteLayout from '../../layouts/SiteLayout.astro'

const apiUrl = (import.meta.env.PUBLIC_API_URL || 'http://localhost:8787').replace(/\/+$/, '')
---

<SiteLayout title="Blog Post">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-12">
    <div class="flex gap-12">
      <article class="flex-1 min-w-0">
        <div id="runtime-config" data-api-url={apiUrl} class="hidden"></div>
        <nav class="flex items-center gap-2 text-sm text-slate-500 mb-8">
          <a href="/" class="hover:text-slate-300 transition-colors">Home</a>
          <span>/</span>
          <a href="/blog" class="hover:text-slate-300 transition-colors">Blog</a>
          <span>/</span>
          <span id="breadcrumb-title" class="text-slate-400 truncate">Loading...</span>
        </nav>

        <div id="error-box" class="hidden card p-6 text-center text-slate-400"></div>

        <div id="article-shell" class="hidden">
          <div id="cover-wrap" class="hidden aspect-video rounded-2xl overflow-hidden mb-10 border border-surface-700">
            <img id="cover-image" alt="Cover" class="w-full h-full object-cover" />
          </div>

          <header class="mb-10">
            <div class="flex flex-wrap items-center gap-2 mb-4">
              <span class="badge-blog">üìù Blog</span>
              <div id="category-list" class="contents"></div>
            </div>

            <h1 id="article-title" class="text-3xl sm:text-4xl font-display font-bold text-white leading-tight mb-5"></h1>

            <div class="flex flex-wrap items-center gap-5 text-sm text-slate-400">
              <span id="created-at"></span>
              <span id="updated-at" class="hidden"></span>
              <span id="view-count"></span>
            </div>
          </header>

          <div id="article-content" class="prose-custom"></div>

          <div id="tag-wrap" class="hidden mt-10 pt-8 border-t border-surface-700">
            <div id="tag-list" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
      </article>
    </div>
  </div>
</SiteLayout>

<script type="module">
  const runtimeConfig = document.getElementById('runtime-config')
  const API = (runtimeConfig?.getAttribute('data-api-url') || 'http://localhost:8787').replace(/\/+$/, '')
  const slug = new URLSearchParams(window.location.search).get('slug')

  const errorBox = document.getElementById('error-box')
  const articleShell = document.getElementById('article-shell')

  function showError(msg) {
    errorBox.textContent = msg
    errorBox.classList.remove('hidden')
    articleShell.classList.add('hidden')
  }

  function splitComma(str) {
    return str ? str.split(',').map((s) => s.trim()).filter(Boolean) : []
  }

  function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  }

  async function load() {
    if (!slug) {
      showError('Missing slug in URL.')
      return
    }

    try {
      let renderMarkdown = (content) => `<pre>${String(content || '').replace(/[&<>"]/g, (ch) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[ch]))}</pre>`
      try {
        const markdown = await import('../../lib/markdown')
        if (typeof markdown.renderMarkdown === 'function') {
          renderMarkdown = markdown.renderMarkdown
        }
      } catch (e) {
        console.warn('Markdown module load failed, using plain fallback.')
      }

      const res = await fetch(`${API}/api/articles/${encodeURIComponent(slug)}`)
      if (!res.ok) throw new Error(`HTTP ${res.status}`)
      const article = await res.json()

      if (article.status !== 'published' || article.type !== 'blog') {
        showError('Article not found.')
        return
      }

      document.title = `${article.title} | Blog`
      document.getElementById('breadcrumb-title').textContent = article.title
      document.getElementById('article-title').textContent = article.title
      document.getElementById('created-at').textContent = `Published ${formatDate(article.created_at)}`

      const updated = document.getElementById('updated-at')
      if (article.updated_at && article.updated_at !== article.created_at) {
        updated.textContent = `Updated ${formatDate(article.updated_at)}`
        updated.classList.remove('hidden')
      }

      document.getElementById('view-count').textContent = `${article.view_count ?? 0} views`

      if (article.cover_image) {
        document.getElementById('cover-image').src = article.cover_image
        document.getElementById('cover-wrap').classList.remove('hidden')
      }

      const cats = splitComma(article.categories)
      const catList = document.getElementById('category-list')
      catList.innerHTML = cats
        .map((cat) => `<span class=\"px-2.5 py-0.5 rounded-full text-xs font-medium bg-surface-700 text-slate-300 border border-surface-600\">${cat}</span>`)
        .join('')

      document.getElementById('article-content').innerHTML = renderMarkdown(article.content || '')

      const tags = splitComma(article.tags)
      if (tags.length > 0) {
        document.getElementById('tag-wrap').classList.remove('hidden')
        document.getElementById('tag-list').innerHTML = tags
          .map((tag) => `<a href=\"/blog?tag=${encodeURIComponent(tag)}\" class=\"tag\">#${tag}</a>`)
          .join('')
      }

      articleShell.classList.remove('hidden')
    } catch (e) {
      showError('Failed to load article.')
    }
  }

  load()
</script>

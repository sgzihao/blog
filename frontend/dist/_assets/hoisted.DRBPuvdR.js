let u="",d="",E=[],x=[];const g="https://techblog-api.sgzihao.workers.dev",C=document.getElementById("login-screen"),A=document.getElementById("admin-screen"),I=document.getElementById("token-input"),B=document.getElementById("login-btn"),f=document.getElementById("login-error"),H=document.getElementById("logout-btn");async function b(){const t=I.value.trim();if(t){B.textContent="Verifying...",f.classList.add("hidden");try{const e=await fetch(`${g}/api/admin/stats`,{headers:{Authorization:`Bearer ${t}`}});if(!e.ok){const n=await e.json().catch(()=>({error:`Login failed (HTTP ${e.status})`}));throw new Error(n.error||`Login failed (HTTP ${e.status})`)}u=t,sessionStorage.setItem("admin_token",t),U()}catch(e){const n=e?.message?.includes("Failed to fetch")?"Network/CORS error: check API URL and ALLOWED_ORIGIN.":e?.message||"Login failed";f.textContent=n,f.classList.remove("hidden")}finally{B.textContent="Sign In"}}}function U(){C.classList.add("hidden"),A.classList.remove("hidden"),p("articles"),M();const t=new URLSearchParams(window.location.search).get("edit");t&&P(t)}const S=sessionStorage.getItem("admin_token");S&&(u=S,I.value=u,b());B.addEventListener("click",b);I.addEventListener("keydown",t=>{t.key==="Enter"&&b()});H.addEventListener("click",()=>{u="",sessionStorage.removeItem("admin_token"),A.classList.add("hidden"),C.classList.remove("hidden"),f.classList.add("hidden"),I.value=""});function p(t){document.querySelectorAll(".tab-btn").forEach(e=>{const n=e.getAttribute("data-tab")===t;e.classList.toggle("bg-surface-700",n),e.classList.toggle("text-white",n),e.classList.toggle("text-slate-400",!n)}),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.toggle("hidden",e.id!==`tab-${t}`)}),t==="articles"&&k(),t==="taxonomy"&&v(),t==="stats"&&R()}document.querySelectorAll(".tab-btn").forEach(t=>{t.addEventListener("click",()=>p(t.getAttribute("data-tab")))});async function l(t,e={}){const n=await fetch(`${g}${t}`,{...e,headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`,...e.headers||{}}});if(!n.ok){const a=await n.json().catch(()=>({error:"Unknown error"}));throw new Error(a.error||`HTTP ${n.status}`)}return n.json()}async function k(){const t=document.getElementById("articles-tbody"),e=document.getElementById("articles-loading"),n=document.getElementById("articles-table"),a=document.getElementById("articles-empty"),s=document.getElementById("filter-type").value,y=document.getElementById("filter-status").value;e.classList.remove("hidden"),n.classList.add("hidden");try{const r=new URLSearchParams;s&&r.set("type",s),y&&r.set("status",y);const h=await l(`/api/admin/articles?${r}`);if(e.classList.add("hidden"),n.classList.remove("hidden"),h.results.length===0){t.innerHTML="",a.classList.remove("hidden");return}a.classList.add("hidden"),t.innerHTML=h.results.map(c=>`
        <tr class="hover:bg-surface-700/30 transition-colors">
          <td class="px-4 py-3">
            <div class="font-medium text-slate-200 line-clamp-1">${c.title}</div>
            <div class="text-slate-500 text-xs font-mono mt-0.5">${c.slug}</div>
          </td>
          <td class="px-4 py-3">
            <span class="${c.type==="blog"?"badge-blog":"badge-wiki"}">${c.type}</span>
          </td>
          <td class="px-4 py-3">
            <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full ${c.status==="published"?"bg-emerald-500/10 text-emerald-400 border border-emerald-500/20":"bg-slate-700 text-slate-400 border border-slate-600"}">
              <span class="w-1.5 h-1.5 rounded-full ${c.status==="published"?"bg-emerald-400":"bg-slate-500"}"></span>
              ${c.status==="published"?"Published":"Draft"}
            </span>
          </td>
          <td class="px-4 py-3 text-slate-500 text-xs hidden md:table-cell">
            ${new Date(c.updated_at).toLocaleDateString("en-US")}
          </td>
          <td class="px-4 py-3 text-right">
            <div class="flex items-center justify-end gap-1">
              <a href="/${c.type}/post?slug=${encodeURIComponent(c.slug)}" target="_blank" class="btn-ghost text-xs py-1 px-2" title="Preview">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
              </a>
              <button onclick="editArticle('${c.slug}')" class="btn-ghost text-xs py-1 px-2">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit
              </button>
            </div>
          </td>
        </tr>
      `).join("")}catch(r){e.textContent=`Load failed: ${r.message}`}}document.getElementById("filter-type").addEventListener("change",k);document.getElementById("filter-status").addEventListener("change",k);document.getElementById("new-article-btn").addEventListener("click",()=>{_(),p("editor")});function _(){d="",document.getElementById("editor-title-heading").textContent="New Article",document.getElementById("ed-title").value="",document.getElementById("ed-slug").value="",document.getElementById("ed-excerpt").value="",document.getElementById("ed-content").value="",document.getElementById("ed-cover").value="",document.getElementById("cover-img").src="",document.getElementById("cover-preview").classList.add("hidden"),document.getElementById("type-blog").checked=!0,document.getElementById("danger-zone").classList.add("hidden"),$()}async function P(t){try{const e=await l(`/api/articles/${t}`);d=t,document.getElementById("editor-title-heading").textContent="Edit Article",document.getElementById("ed-title").value=e.title,document.getElementById("ed-slug").value=e.slug,document.getElementById("ed-excerpt").value=e.excerpt||"",document.getElementById("ed-content").value=e.content,document.getElementById("ed-cover").value=e.cover_image||"",e.cover_image&&(document.getElementById("cover-img").src=e.cover_image,document.getElementById("cover-preview").classList.remove("hidden")),document.getElementById(`type-${e.type}`).checked=!0,document.getElementById("danger-zone").classList.remove("hidden");const n=e.category_ids?.split(",").map(Number).filter(Boolean)||[],a=e.tag_id_list?.split(",").map(Number).filter(Boolean)||[];$(n,a),p("editor")}catch(e){o(`Failed to load article: ${e.message}`,"error")}}window.editArticle=P;function N(){const t=document.getElementById("ed-slug").value.trim(),e=document.querySelector('input[name="ed-type"]:checked').value;return t?`/${e}/post?slug=${encodeURIComponent(t)}`:null}async function j(t){const e=document.getElementById("ed-title").value.trim(),n=document.getElementById("ed-slug").value.trim(),a=document.getElementById("ed-content").value.trim(),s=document.getElementById("ed-excerpt").value.trim(),y=document.getElementById("ed-cover").value.trim(),r=document.querySelector('input[name="ed-type"]:checked').value;if(!e||!n||!a){o("Please fill in title, slug, and content","error");return}const h=Array.from(document.querySelectorAll('input[name="cat-check"]:checked')).map(i=>parseInt(i.value)),c=Array.from(document.querySelectorAll('input[name="tag-check"]:checked')).map(i=>parseInt(i.value)),T={title:e,slug:n,content:a,excerpt:s||void 0,type:r,status:t,cover_image:y||void 0,category_ids:h,tag_ids:c};try{if(d?(await l(`/api/admin/articles/${d}`,{method:"PUT",body:JSON.stringify(T)}),o(`Article saved as ${t==="published"?"published":"draft"}`,"success"),d=n):(await l("/api/admin/articles",{method:"POST",body:JSON.stringify(T)}),d=n,o(`Article created ${t==="published"?"and published":"as draft"}`,"success")),document.getElementById("editor-title-heading").textContent="Edit Article",document.getElementById("danger-zone").classList.remove("hidden"),t==="published"){const i=`/${r}/post?slug=${encodeURIComponent(n)}`;window.open(i,"_blank","noopener,noreferrer")}}catch(i){o(`Save failed: ${i.message}`,"error")}}document.getElementById("publish-btn").addEventListener("click",()=>j("published"));document.getElementById("save-draft-btn").addEventListener("click",()=>j("draft"));document.getElementById("open-preview-btn").addEventListener("click",()=>{const t=N();if(!t){o("Please enter a slug to open preview","error");return}window.open(t,"_blank","noopener,noreferrer")});document.getElementById("delete-article-btn").addEventListener("click",async()=>{if(d&&confirm(`Delete article "${d}"? This cannot be undone.`))try{await l(`/api/admin/articles/${d}`,{method:"DELETE"}),o("Article deleted","success"),_(),p("articles")}catch(t){o(`Delete failed: ${t.message}`,"error")}});document.getElementById("ed-title").addEventListener("input",t=>{if(d)return;const n=t.target.value.toLowerCase().replace(/[\s_]+/g,"-").replace(/[^\w\-\u4e00-\u9fff]+/g,"").replace(/^-+|-+$/g,"");document.getElementById("ed-slug").value=n});let w=!1;function O(t){return`<pre>${String(t||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>`}document.getElementById("preview-toggle").addEventListener("click",async()=>{w=!w;const t=document.getElementById("ed-content"),e=document.getElementById("ed-preview"),n=document.getElementById("preview-toggle");if(w){const a=t.value;e.innerHTML=O(a),t.classList.add("hidden"),e.classList.remove("hidden"),n.textContent="Edit"}else t.classList.remove("hidden"),e.classList.add("hidden"),n.textContent="Preview"});const m=document.getElementById("cover-drop-zone"),L=document.getElementById("cover-file-input");m.addEventListener("click",()=>L.click());m.addEventListener("dragover",t=>{t.preventDefault(),m.classList.add("border-accent-cyan/60")});m.addEventListener("dragleave",()=>m.classList.remove("border-accent-cyan/60"));m.addEventListener("drop",t=>{t.preventDefault(),m.classList.remove("border-accent-cyan/60");const e=t.dataTransfer?.files[0];e&&D(e)});L.addEventListener("change",()=>{const t=L.files?.[0];t&&D(t)});async function D(t){const e=document.getElementById("upload-progress");e.classList.remove("hidden");try{const n=new FormData;n.append("file",t);const a=await fetch(`${g}/api/upload/image`,{method:"POST",headers:{Authorization:`Bearer ${u}`},body:n});if(!a.ok)throw new Error("Upload failed");const{url:s}=await a.json();document.getElementById("ed-cover").value=s,document.getElementById("cover-img").src=s,document.getElementById("cover-preview").classList.remove("hidden"),o("Image uploaded successfully","success")}catch(n){o(`Upload failed: ${n.message}`,"error")}finally{e.classList.add("hidden")}}document.getElementById("ed-cover").addEventListener("change",t=>{const e=t.target.value;e&&(document.getElementById("cover-img").src=e,document.getElementById("cover-preview").classList.remove("hidden"))});async function M(){const[t,e]=await Promise.all([fetch(`${g}/api/categories`).then(n=>n.json()),fetch(`${g}/api/tags`).then(n=>n.json())]);E=t,x=e}function $(t=[],e=[]){const n=document.getElementById("categories-checkboxes"),a=document.getElementById("tags-checkboxes");n.innerHTML=E.length>0?E.map(s=>`
      <label class="flex items-center gap-2 cursor-pointer hover:text-slate-200 transition-colors">
        <input type="checkbox" name="cat-check" value="${s.id}" ${t.includes(s.id)?"checked":""} class="accent-cyan-400 rounded" />
        <span class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${s.color}"></span>
        <span class="text-sm text-slate-300">${s.name}</span>
      </label>
    `).join(""):'<span class="text-slate-500 text-xs">No categories yet. Create one in "Categories/Tags".</span>',a.innerHTML=x.length>0?x.map(s=>`
      <label class="tag cursor-pointer ${e.includes(s.id)?"tag-active":""}">
        <input type="checkbox" name="tag-check" value="${s.id}" ${e.includes(s.id)?"checked":""} class="sr-only" />
        #${s.name}
      </label>
    `).join(""):'<span class="text-slate-500 text-xs">No tags yet</span>',a.querySelectorAll("label.tag").forEach(s=>{s.addEventListener("click",()=>{s.classList.toggle("tag-active")})})}async function v(){await M(),$();const t=document.getElementById("categories-list");t.innerHTML=E.map(n=>`
      <div class="card p-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full" style="background-color: ${n.color}"></span>
          <span class="text-slate-200 text-sm">${n.name}</span>
          <span class="font-mono text-slate-500 text-xs">/${n.slug}</span>
          ${n.count>0?`<span class="text-slate-600 text-xs">${n.count} posts</span>`:""}
        </div>
        <button onclick="deleteCategory(${n.id})" class="text-slate-600 hover:text-red-400 transition-colors text-xs p-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    `).join("")||'<div class="text-slate-500 text-sm text-center py-8">No categories yet</div>';const e=document.getElementById("tags-list");e.innerHTML=x.map(n=>`
      <span class="tag group relative">
        #${n.name}
        ${n.count>0?`<span class="text-slate-600 ml-1">${n.count}</span>`:""}
        <button onclick="deleteTag(${n.id})" class="ml-1 text-slate-600 hover:text-red-400 transition-colors">√ó</button>
      </span>
    `).join("")||'<div class="text-slate-500 text-sm">No tags yet</div>'}document.getElementById("new-cat-btn").addEventListener("click",()=>{document.getElementById("new-cat-form").classList.toggle("hidden")});document.getElementById("cancel-cat-btn").addEventListener("click",()=>{document.getElementById("new-cat-form").classList.add("hidden")});document.getElementById("save-cat-btn").addEventListener("click",async()=>{const t=document.getElementById("cat-name").value.trim(),e=document.getElementById("cat-slug").value.trim(),n=document.getElementById("cat-desc").value.trim(),a=document.getElementById("cat-color").value;if(!t||!e)return o("Please enter name and slug","error");try{await l("/api/admin/categories",{method:"POST",body:JSON.stringify({name:t,slug:e,description:n,color:a})}),o("Category created successfully","success"),document.getElementById("cat-name").value="",document.getElementById("cat-slug").value="",document.getElementById("new-cat-form").classList.add("hidden"),await v()}catch(s){o(s.message,"error")}});document.getElementById("new-tag-btn").addEventListener("click",()=>{document.getElementById("new-tag-form").classList.toggle("hidden")});document.getElementById("cancel-tag-btn").addEventListener("click",()=>{document.getElementById("new-tag-form").classList.add("hidden")});document.getElementById("save-tag-btn").addEventListener("click",async()=>{const t=document.getElementById("tag-name").value.trim(),e=document.getElementById("tag-slug").value.trim();if(!t||!e)return o("Please enter name and slug","error");try{await l("/api/admin/tags",{method:"POST",body:JSON.stringify({name:t,slug:e})}),o("Tag created successfully","success"),document.getElementById("tag-name").value="",document.getElementById("tag-slug").value="",document.getElementById("new-tag-form").classList.add("hidden"),await v()}catch(n){o(n.message,"error")}});window.deleteCategory=async t=>{if(confirm("Delete this category?"))try{await l(`/api/admin/categories/${t}`,{method:"DELETE"}),o("Category deleted","success"),await v()}catch(e){o(e.message,"error")}};window.deleteTag=async t=>{if(confirm("Delete this tag?"))try{await l(`/api/admin/tags/${t}`,{method:"DELETE"}),o("Tag deleted","success"),await v()}catch(e){o(e.message,"error")}};async function R(){const t=document.getElementById("stats-grid");try{const e=await l("/api/admin/stats"),n=[{label:"Total Articles",value:e.total_articles,icon:"üìÑ",color:"text-white"},{label:"Published",value:e.published_articles,icon:"‚úÖ",color:"text-emerald-400"},{label:"Draft",value:e.draft_articles,icon:"üìù",color:"text-slate-300"},{label:"Total Views",value:e.total_views.toLocaleString(),icon:"üëÅÔ∏è",color:"text-accent-cyan"},{label:"Categories",value:e.total_categories,icon:"üìÅ",color:"text-slate-300"},{label:"Tags",value:e.total_tags,icon:"üè∑Ô∏è",color:"text-slate-300"}];t.innerHTML=n.map(a=>`
        <div class="card p-6 text-center">
          <div class="text-3xl mb-2">${a.icon}</div>
          <div class="text-3xl font-display font-bold ${a.color} mb-1">${a.value}</div>
          <div class="text-slate-500 text-sm">${a.label}</div>
        </div>
      `).join("")}catch(e){t.innerHTML=`<div class="text-red-400 text-sm">${e.message}</div>`}}function o(t,e="info"){const n=document.getElementById("toast-container"),a=document.createElement("div");a.className=`pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl shadow-xl text-sm font-medium animate-in ${e==="success"?"bg-emerald-500/90 text-white":e==="error"?"bg-red-500/90 text-white":"bg-surface-700 text-slate-200 border border-surface-600"}`,a.innerHTML=`
      ${e==="success"?"‚úÖ":e==="error"?"‚ùå":"‚ÑπÔ∏è"}
      <span>${t}</span>
    `,n.appendChild(a),setTimeout(()=>a.remove(),3e3)}document.getElementById("tag-name").addEventListener("input",t=>{const e=t.target.value;document.getElementById("tag-slug").value=e.toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-\u4e00-\u9fff]/g,"")});document.getElementById("cat-name").addEventListener("input",t=>{const e=t.target.value;document.getElementById("cat-slug").value=e.toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-\u4e00-\u9fff]/g,"")});

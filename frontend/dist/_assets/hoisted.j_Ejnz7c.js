const R="modulepreload",q=function(t){return"/"+t},C={},z=function(e,n,s){let a=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),l=d?.nonce||d?.getAttribute("nonce");a=Promise.allSettled(n.map(o=>{if(o=q(o),o in C)return;C[o]=!0;const v=o.endsWith(".css"),u=v?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${u}`))return;const g=document.createElement("link");if(g.rel=v?"stylesheet":R,v||(g.as="script"),g.crossOrigin="",g.href=o,l&&g.setAttribute("nonce",l),document.head.appendChild(g),v)return new Promise((H,O)=>{g.addEventListener("load",H),g.addEventListener("error",()=>O(new Error(`Unable to preload CSS for ${o}`)))})}))}function m(d){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=d,window.dispatchEvent(l),!l.defaultPrevented)throw d}return a.then(d=>{for(const l of d||[])l.status==="rejected"&&m(l.reason);return e().catch(m)})};let p="",r="",x=[],I=[];const h="http://localhost:8787",_=document.getElementById("login-screen"),P=document.getElementById("admin-screen"),B=document.getElementById("token-input"),b=document.getElementById("login-btn"),w=document.getElementById("login-error"),F=document.getElementById("logout-btn");async function $(){const t=B.value.trim();if(t){b.textContent="Verifying...",w.classList.add("hidden");try{const e=await fetch(`${h}/api/admin/stats`,{headers:{Authorization:`Bearer ${t}`}});if(!e.ok){const n=await e.json().catch(()=>({error:`Login failed (HTTP ${e.status})`}));throw new Error(n.error||`Login failed (HTTP ${e.status})`)}p=t,sessionStorage.setItem("admin_token",t),J()}catch(e){const n=e?.message?.includes("Failed to fetch")?"Network/CORS error: check API URL and ALLOWED_ORIGIN.":e?.message||"Login failed";w.textContent=n,w.classList.remove("hidden")}finally{b.textContent="Sign In"}}}function J(){_.classList.add("hidden"),P.classList.remove("hidden"),f("articles"),N();const t=new URLSearchParams(window.location.search).get("edit");t&&M(t)}const A=sessionStorage.getItem("admin_token");A&&(p=A,B.value=p,$());b.addEventListener("click",$);B.addEventListener("keydown",t=>{t.key==="Enter"&&$()});F.addEventListener("click",()=>{p="",sessionStorage.removeItem("admin_token"),P.classList.add("hidden"),_.classList.remove("hidden"),w.classList.add("hidden"),B.value=""});function f(t){document.querySelectorAll(".tab-btn").forEach(e=>{const n=e.getAttribute("data-tab")===t;e.classList.toggle("bg-surface-700",n),e.classList.toggle("text-white",n),e.classList.toggle("text-slate-400",!n)}),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.toggle("hidden",e.id!==`tab-${t}`)}),t==="articles"&&T(),t==="taxonomy"&&E(),t==="stats"&&W()}document.querySelectorAll(".tab-btn").forEach(t=>{t.addEventListener("click",()=>f(t.getAttribute("data-tab")))});async function i(t,e={}){const n=await fetch(`${h}${t}`,{...e,headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`,...e.headers||{}}});if(!n.ok){const s=await n.json().catch(()=>({error:"Unknown error"}));throw new Error(s.error||`HTTP ${n.status}`)}return n.json()}async function T(){const t=document.getElementById("articles-tbody"),e=document.getElementById("articles-loading"),n=document.getElementById("articles-table"),s=document.getElementById("articles-empty"),a=document.getElementById("filter-type").value,m=document.getElementById("filter-status").value;e.classList.remove("hidden"),n.classList.add("hidden");try{const d=new URLSearchParams;a&&d.set("type",a),m&&d.set("status",m);const l=await i(`/api/admin/articles?${d}`);if(e.classList.add("hidden"),n.classList.remove("hidden"),l.results.length===0){t.innerHTML="",s.classList.remove("hidden");return}s.classList.add("hidden"),t.innerHTML=l.results.map(o=>`
        <tr class="hover:bg-surface-700/30 transition-colors">
          <td class="px-4 py-3">
            <div class="font-medium text-slate-200 line-clamp-1">${o.title}</div>
            <div class="text-slate-500 text-xs font-mono mt-0.5">${o.slug}</div>
          </td>
          <td class="px-4 py-3">
            <span class="${o.type==="blog"?"badge-blog":"badge-wiki"}">${o.type}</span>
          </td>
          <td class="px-4 py-3">
            <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full ${o.status==="published"?"bg-emerald-500/10 text-emerald-400 border border-emerald-500/20":"bg-slate-700 text-slate-400 border border-slate-600"}">
              <span class="w-1.5 h-1.5 rounded-full ${o.status==="published"?"bg-emerald-400":"bg-slate-500"}"></span>
              ${o.status==="published"?"Published":"Draft"}
            </span>
          </td>
          <td class="px-4 py-3 text-slate-500 text-xs hidden md:table-cell">
            ${new Date(o.updated_at).toLocaleDateString("en-US")}
          </td>
          <td class="px-4 py-3 text-right">
            <div class="flex items-center justify-end gap-1">
              <a href="/${o.type}/post?slug=${encodeURIComponent(o.slug)}" target="_blank" class="btn-ghost text-xs py-1 px-2" title="Preview">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
              </a>
              <button onclick="editArticle('${o.slug}')" class="btn-ghost text-xs py-1 px-2">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit
              </button>
            </div>
          </td>
        </tr>
      `).join("")}catch(d){e.textContent=`Load failed: ${d.message}`}}document.getElementById("filter-type").addEventListener("change",T);document.getElementById("filter-status").addEventListener("change",T);document.getElementById("new-article-btn").addEventListener("click",()=>{j(),f("editor")});function j(){r="",document.getElementById("editor-title-heading").textContent="New Article",document.getElementById("ed-title").value="",document.getElementById("ed-slug").value="",document.getElementById("ed-excerpt").value="",document.getElementById("ed-content").value="",document.getElementById("ed-cover").value="",document.getElementById("cover-img").src="",document.getElementById("cover-preview").classList.add("hidden"),document.getElementById("type-blog").checked=!0,document.getElementById("danger-zone").classList.add("hidden"),S()}async function M(t){try{const e=await i(`/api/articles/${t}`);r=t,document.getElementById("editor-title-heading").textContent="Edit Article",document.getElementById("ed-title").value=e.title,document.getElementById("ed-slug").value=e.slug,document.getElementById("ed-excerpt").value=e.excerpt||"",document.getElementById("ed-content").value=e.content,document.getElementById("ed-cover").value=e.cover_image||"",e.cover_image&&(document.getElementById("cover-img").src=e.cover_image,document.getElementById("cover-preview").classList.remove("hidden")),document.getElementById(`type-${e.type}`).checked=!0,document.getElementById("danger-zone").classList.remove("hidden");const n=e.category_ids?.split(",").map(Number).filter(Boolean)||[],s=e.tag_id_list?.split(",").map(Number).filter(Boolean)||[];S(n,s),f("editor")}catch(e){c(`Failed to load article: ${e.message}`,"error")}}window.editArticle=M;function V(){const t=document.getElementById("ed-slug").value.trim(),e=document.querySelector('input[name="ed-type"]:checked').value;return t?`/${e}/post?slug=${encodeURIComponent(t)}`:null}async function D(t){const e=document.getElementById("ed-title").value.trim(),n=document.getElementById("ed-slug").value.trim(),s=document.getElementById("ed-content").value.trim(),a=document.getElementById("ed-excerpt").value.trim(),m=document.getElementById("ed-cover").value.trim(),d=document.querySelector('input[name="ed-type"]:checked').value;if(!e||!n||!s){c("Please fill in title, slug, and content","error");return}const l=Array.from(document.querySelectorAll('input[name="cat-check"]:checked')).map(u=>parseInt(u.value)),o=Array.from(document.querySelectorAll('input[name="tag-check"]:checked')).map(u=>parseInt(u.value)),v={title:e,slug:n,content:s,excerpt:a||void 0,type:d,status:t,cover_image:m||void 0,category_ids:l,tag_ids:o};try{if(r?(await i(`/api/admin/articles/${r}`,{method:"PUT",body:JSON.stringify(v)}),c(`Article saved as ${t==="published"?"published":"draft"}`,"success"),r=n):(await i("/api/admin/articles",{method:"POST",body:JSON.stringify(v)}),r=n,c(`Article created ${t==="published"?"and published":"as draft"}`,"success")),document.getElementById("editor-title-heading").textContent="Edit Article",document.getElementById("danger-zone").classList.remove("hidden"),t==="published"){const u=`/${d}/post?slug=${encodeURIComponent(n)}`;window.open(u,"_blank","noopener,noreferrer")}}catch(u){c(`Save failed: ${u.message}`,"error")}}document.getElementById("publish-btn").addEventListener("click",()=>D("published"));document.getElementById("save-draft-btn").addEventListener("click",()=>D("draft"));document.getElementById("open-preview-btn").addEventListener("click",()=>{const t=V();if(!t){c("Please enter a slug to open preview","error");return}window.open(t,"_blank","noopener,noreferrer")});document.getElementById("delete-article-btn").addEventListener("click",async()=>{if(r&&confirm(`Delete article "${r}"? This cannot be undone.`))try{await i(`/api/admin/articles/${r}`,{method:"DELETE"}),c("Article deleted","success"),j(),f("articles")}catch(t){c(`Delete failed: ${t.message}`,"error")}});document.getElementById("ed-title").addEventListener("input",t=>{if(r)return;const n=t.target.value.toLowerCase().replace(/[\s_]+/g,"-").replace(/[^\w\-\u4e00-\u9fff]+/g,"").replace(/^-+|-+$/g,"");document.getElementById("ed-slug").value=n});let L=!1;document.getElementById("preview-toggle").addEventListener("click",async()=>{L=!L;const t=document.getElementById("ed-content"),e=document.getElementById("ed-preview"),n=document.getElementById("preview-toggle");if(L){const s=t.value,{renderMarkdown:a}=await z(async()=>{const{renderMarkdown:m}=await import("./markdown.D1L_EcYA.js");return{renderMarkdown:m}},[]);e.innerHTML=a(s),t.classList.add("hidden"),e.classList.remove("hidden"),n.textContent="Edit"}else t.classList.remove("hidden"),e.classList.add("hidden"),n.textContent="Preview"});const y=document.getElementById("cover-drop-zone"),k=document.getElementById("cover-file-input");y.addEventListener("click",()=>k.click());y.addEventListener("dragover",t=>{t.preventDefault(),y.classList.add("border-accent-cyan/60")});y.addEventListener("dragleave",()=>y.classList.remove("border-accent-cyan/60"));y.addEventListener("drop",t=>{t.preventDefault(),y.classList.remove("border-accent-cyan/60");const e=t.dataTransfer?.files[0];e&&U(e)});k.addEventListener("change",()=>{const t=k.files?.[0];t&&U(t)});async function U(t){const e=document.getElementById("upload-progress");e.classList.remove("hidden");try{const n=new FormData;n.append("file",t);const s=await fetch(`${h}/api/upload/image`,{method:"POST",headers:{Authorization:`Bearer ${p}`},body:n});if(!s.ok)throw new Error("Upload failed");const{url:a}=await s.json();document.getElementById("ed-cover").value=a,document.getElementById("cover-img").src=a,document.getElementById("cover-preview").classList.remove("hidden"),c("Image uploaded successfully","success")}catch(n){c(`Upload failed: ${n.message}`,"error")}finally{e.classList.add("hidden")}}document.getElementById("ed-cover").addEventListener("change",t=>{const e=t.target.value;e&&(document.getElementById("cover-img").src=e,document.getElementById("cover-preview").classList.remove("hidden"))});async function N(){const[t,e]=await Promise.all([fetch(`${h}/api/categories`).then(n=>n.json()),fetch(`${h}/api/tags`).then(n=>n.json())]);x=t,I=e}function S(t=[],e=[]){const n=document.getElementById("categories-checkboxes"),s=document.getElementById("tags-checkboxes");n.innerHTML=x.length>0?x.map(a=>`
      <label class="flex items-center gap-2 cursor-pointer hover:text-slate-200 transition-colors">
        <input type="checkbox" name="cat-check" value="${a.id}" ${t.includes(a.id)?"checked":""} class="accent-cyan-400 rounded" />
        <span class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${a.color}"></span>
        <span class="text-sm text-slate-300">${a.name}</span>
      </label>
    `).join(""):'<span class="text-slate-500 text-xs">No categories yet. Create one in "Categories/Tags".</span>',s.innerHTML=I.length>0?I.map(a=>`
      <label class="tag cursor-pointer ${e.includes(a.id)?"tag-active":""}">
        <input type="checkbox" name="tag-check" value="${a.id}" ${e.includes(a.id)?"checked":""} class="sr-only" />
        #${a.name}
      </label>
    `).join(""):'<span class="text-slate-500 text-xs">No tags yet</span>',s.querySelectorAll("label.tag").forEach(a=>{a.addEventListener("click",()=>{a.classList.toggle("tag-active")})})}async function E(){await N(),S();const t=document.getElementById("categories-list");t.innerHTML=x.map(n=>`
      <div class="card p-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full" style="background-color: ${n.color}"></span>
          <span class="text-slate-200 text-sm">${n.name}</span>
          <span class="font-mono text-slate-500 text-xs">/${n.slug}</span>
          ${n.count>0?`<span class="text-slate-600 text-xs">${n.count} posts</span>`:""}
        </div>
        <button onclick="deleteCategory(${n.id})" class="text-slate-600 hover:text-red-400 transition-colors text-xs p-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    `).join("")||'<div class="text-slate-500 text-sm text-center py-8">No categories yet</div>';const e=document.getElementById("tags-list");e.innerHTML=I.map(n=>`
      <span class="tag group relative">
        #${n.name}
        ${n.count>0?`<span class="text-slate-600 ml-1">${n.count}</span>`:""}
        <button onclick="deleteTag(${n.id})" class="ml-1 text-slate-600 hover:text-red-400 transition-colors">√ó</button>
      </span>
    `).join("")||'<div class="text-slate-500 text-sm">No tags yet</div>'}document.getElementById("new-cat-btn").addEventListener("click",()=>{document.getElementById("new-cat-form").classList.toggle("hidden")});document.getElementById("cancel-cat-btn").addEventListener("click",()=>{document.getElementById("new-cat-form").classList.add("hidden")});document.getElementById("save-cat-btn").addEventListener("click",async()=>{const t=document.getElementById("cat-name").value.trim(),e=document.getElementById("cat-slug").value.trim(),n=document.getElementById("cat-desc").value.trim(),s=document.getElementById("cat-color").value;if(!t||!e)return c("Please enter name and slug","error");try{await i("/api/admin/categories",{method:"POST",body:JSON.stringify({name:t,slug:e,description:n,color:s})}),c("Category created successfully","success"),document.getElementById("cat-name").value="",document.getElementById("cat-slug").value="",document.getElementById("new-cat-form").classList.add("hidden"),await E()}catch(a){c(a.message,"error")}});document.getElementById("new-tag-btn").addEventListener("click",()=>{document.getElementById("new-tag-form").classList.toggle("hidden")});document.getElementById("cancel-tag-btn").addEventListener("click",()=>{document.getElementById("new-tag-form").classList.add("hidden")});document.getElementById("save-tag-btn").addEventListener("click",async()=>{const t=document.getElementById("tag-name").value.trim(),e=document.getElementById("tag-slug").value.trim();if(!t||!e)return c("Please enter name and slug","error");try{await i("/api/admin/tags",{method:"POST",body:JSON.stringify({name:t,slug:e})}),c("Tag created successfully","success"),document.getElementById("tag-name").value="",document.getElementById("tag-slug").value="",document.getElementById("new-tag-form").classList.add("hidden"),await E()}catch(n){c(n.message,"error")}});window.deleteCategory=async t=>{if(confirm("Delete this category?"))try{await i(`/api/admin/categories/${t}`,{method:"DELETE"}),c("Category deleted","success"),await E()}catch(e){c(e.message,"error")}};window.deleteTag=async t=>{if(confirm("Delete this tag?"))try{await i(`/api/admin/tags/${t}`,{method:"DELETE"}),c("Tag deleted","success"),await E()}catch(e){c(e.message,"error")}};async function W(){const t=document.getElementById("stats-grid");try{const e=await i("/api/admin/stats"),n=[{label:"Total Articles",value:e.total_articles,icon:"üìÑ",color:"text-white"},{label:"Published",value:e.published_articles,icon:"‚úÖ",color:"text-emerald-400"},{label:"Draft",value:e.draft_articles,icon:"üìù",color:"text-slate-300"},{label:"Total Views",value:e.total_views.toLocaleString(),icon:"üëÅÔ∏è",color:"text-accent-cyan"},{label:"Categories",value:e.total_categories,icon:"üìÅ",color:"text-slate-300"},{label:"Tags",value:e.total_tags,icon:"üè∑Ô∏è",color:"text-slate-300"}];t.innerHTML=n.map(s=>`
        <div class="card p-6 text-center">
          <div class="text-3xl mb-2">${s.icon}</div>
          <div class="text-3xl font-display font-bold ${s.color} mb-1">${s.value}</div>
          <div class="text-slate-500 text-sm">${s.label}</div>
        </div>
      `).join("")}catch(e){t.innerHTML=`<div class="text-red-400 text-sm">${e.message}</div>`}}function c(t,e="info"){const n=document.getElementById("toast-container"),s=document.createElement("div");s.className=`pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl shadow-xl text-sm font-medium animate-in ${e==="success"?"bg-emerald-500/90 text-white":e==="error"?"bg-red-500/90 text-white":"bg-surface-700 text-slate-200 border border-surface-600"}`,s.innerHTML=`
      ${e==="success"?"‚úÖ":e==="error"?"‚ùå":"‚ÑπÔ∏è"}
      <span>${t}</span>
    `,n.appendChild(s),setTimeout(()=>s.remove(),3e3)}document.getElementById("tag-name").addEventListener("input",t=>{const e=t.target.value;document.getElementById("tag-slug").value=e.toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-\u4e00-\u9fff]/g,"")});document.getElementById("cat-name").addEventListener("input",t=>{const e=t.target.value;document.getElementById("cat-slug").value=e.toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-\u4e00-\u9fff]/g,"")});
